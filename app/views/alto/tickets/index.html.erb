<div class="space-y-6">
  <% actions = [] %>
  <% if can_submit_tickets? %>
    <% actions << {
      type: :link,
      text: "New #{board_item_name(@board).capitalize}",
      path: alto.new_board_ticket_path(@board),
      button_type: :primary
    } %>
  <% end %>

  <% if can_access_admin? %>
    <% actions << {
      type: :link,
      text: "Modify Board",
              path: alto.edit_admin_board_path(@board.slug),
      button_type: :secondary
    } %>
  <% end %>

  <%= render 'shared/page_header',
      title: @board.name,
      actions: actions %>

      <%
    # Read view preference from URL parameter, default to 'card'
    view_type = params[:view] == 'list' ? 'list' : 'card'
    show_status_filters = view_type == 'list'
  %>

  <!-- Status Filter with Recent/Popular alignment and View Toggle -->
  <div class="flex justify-between items-center flex-wrap gap-4">
    <!-- Status filters (only show in list view) -->
    <div id="status-filters" class="flex flex-wrap gap-2" <%= 'style="display: none;"'.html_safe unless show_status_filters %>>
      <%= link_to "All", alto.board_tickets_path(@board, search: params[:search], sort: params[:sort], view: params[:view]),
          class: "px-3 py-1 text-sm rounded-full border #{'bg-gray-900 text-white' if params[:status].blank?} #{'bg-white text-gray-700 hover:bg-gray-50' unless params[:status].blank?}" %>
      <% if @board.has_status_tracking? %>
        <% @statuses.each do |status| %>
          <%= link_to status.name, alto.board_tickets_path(@board, status: status.slug, search: params[:search], sort: params[:sort], view: params[:view]),
              class: "px-3 py-1 text-sm rounded-full border #{'bg-gray-900 text-white' if params[:status] == status.slug} #{'bg-white text-gray-700 hover:bg-gray-50' unless params[:status] == status.slug}" %>
        <% end %>
      <% end %>
    </div>

    <div class="flex items-center gap-4">
              <!-- View Toggle -->
        <% if @board.has_status_tracking? && params[:status].blank? %>
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-600">View:</span>
            <div class="flex bg-gray-100 rounded-md p-1">
              <%= link_to alto.board_tickets_path(@board, search: params[:search], sort: params[:sort], view: 'card'),
                  class: "px-3 py-1 text-sm rounded-md transition-colors #{'bg-white text-gray-900 shadow-sm' if view_type == 'card'} #{'text-gray-600 hover:text-gray-900' if view_type != 'card'}" do %>
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
                Board
              <% end %>
              <%= link_to alto.board_tickets_path(@board, search: params[:search], sort: params[:sort], view: 'list'),
                  class: "px-3 py-1 text-sm rounded-md transition-colors #{'bg-white text-gray-900 shadow-sm' if view_type == 'list'} #{'text-gray-600 hover:text-gray-900' if view_type != 'list'}" do %>
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                </svg>
                List
              <% end %>
            </div>
          </div>
        <% end %>

              <!-- Sort Toggle -->
        <div class="flex space-x-2">
          <%= link_to "Recent", alto.board_tickets_path(@board, sort: 'recent', search: params[:search], status: params[:status], view: params[:view]),
              class: "px-3 py-2 text-sm rounded-md #{'bg-blue-100 text-blue-700' if params[:sort] != 'popular'} #{'text-gray-600 hover:text-gray-900' if params[:sort] == 'popular'}" %>
          <%= link_to "Popular", alto.board_tickets_path(@board, sort: 'popular', search: params[:search], status: params[:status], view: params[:view]),
              class: "px-3 py-2 text-sm rounded-md #{'bg-blue-100 text-blue-700' if params[:sort] == 'popular'} #{'text-gray-600 hover:text-gray-900' if params[:sort] != 'popular'}" %>
        </div>
    </div>
  </div>

  <!-- Search Results Info -->
  <% if @search_query.present? %>
    <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
      <div class="flex">
        <div class="ml-3">
          <p class="text-sm text-blue-700">
            <span class="font-medium">Search results for:</span> "<%= @search_query %>"
            <% if @tickets.respond_to?(:total_count) %>
              • <%= pluralize(@tickets.total_count, board_item_name(@board)) %> found
            <% else %>
              • <%= pluralize(@tickets.count, board_item_name(@board)) %> found
            <% end %>
          </p>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Card View (Kanban Style) -->
  <div id="card-view" class="kanban-view" <%= 'style="display: none;"'.html_safe if view_type == 'row' %>>
    <% if @tickets.any? && @board.has_status_tracking? %>
      <div class="flex gap-6 overflow-x-auto pb-4">
        <% @statuses.each do |status| %>
          <% status_tickets = @tickets.select { |t| t.status_slug == status.slug } %>
          <div class="flex-shrink-0 w-80 bg-gray-50 rounded-lg p-4">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center">
                <span class="w-3 h-3 rounded-full mr-2 <%= case status.color
                  when 'green' then 'bg-green-500'
                  when 'blue' then 'bg-blue-500'
                  when 'yellow' then 'bg-yellow-500'
                  when 'red' then 'bg-red-500'
                  when 'gray' then 'bg-gray-500'
                  when 'purple' then 'bg-purple-500'
                  when 'orange' then 'bg-orange-500'
                  when 'pink' then 'bg-pink-500'
                  else 'bg-gray-500'
                  end %>"></span>
                <h3 class="font-semibold text-gray-900"><%= status.name %></h3>
              </div>
              <span class="text-sm text-gray-500 bg-white px-2 py-1 rounded-full"><%= status_tickets.count %></span>
            </div>

            <div class="space-y-3 max-h-96 overflow-y-auto">
              <% status_tickets.each do |ticket| %>
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 hover:shadow-md transition-shadow">
                  <!-- Title and vote arrow row -->
                  <div class="flex items-start justify-between gap-3 mb-3">
                    <div class="flex-1 min-w-0">
                      <h4 class="font-medium text-gray-900 text-sm leading-tight">
                        <%= link_to ticket.title, alto.board_ticket_path(@board, ticket), class: "hover:text-blue-600" %>
                      </h4>
                    </div>
                    <div class="flex-shrink-0">
                      <%= upvote_button(ticket, current_user, size: 'sm') %>
                    </div>
                  </div>

                  <!-- Content preview -->
                  <% if ticket.description.present? %>
                    <div class="mb-3">
                      <p class="text-gray-600 text-xs line-clamp-2">
                        <%= truncate(ticket.description, length: 80) %>
                      </p>
                    </div>
                  <% end %>

                  <!-- Separator line -->
                  <div class="border-t border-gray-100 pt-3">
                    <!-- Comments count and timestamp -->
                    <div class="flex items-center justify-between text-xs">
                      <div>
                        <% if ticket.comments.count > 0 %>
                          <%= link_to pluralize(ticket.comments.count, 'comment'),
                              alto.board_ticket_path(@board, ticket, anchor: 'comments'),
                              class: "text-gray-500 hover:text-blue-600 font-medium" %>
                        <% else %>
                          <span class="text-gray-400">No comments</span>
                        <% end %>
                      </div>
                      <div class="text-gray-500">
                        <%= time_ago_in_words(ticket.created_at) %> ago
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- Row View (Traditional List) -->
  <div id="row-view" class="space-y-4" <%= 'style="display: none;"'.html_safe if view_type == 'card' %>>
    <% if @tickets.any? %>
      <% @tickets.each do |ticket| %>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
          <!-- Top row: Title/Description + Voting -->
          <div class="flex items-start justify-between mb-3">
            <div class="flex-1">
              <!-- Status Badge -->
              <% if @board.has_status_tracking? %>
                <div class="mb-2">
                  <span class="px-2 py-1 text-xs font-medium rounded-full <%= ticket.status_color_classes %>">
                    <%= ticket.status_name %>
                  </span>
                  <% if ticket.locked? %>
                    <span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800 ml-2">
                      🔒 Locked
                    </span>
                  <% end %>
                </div>
              <% else %>
                <% if ticket.locked? %>
                  <div class="mb-2">
                    <span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">
                      🔒 Locked
                    </span>
                  </div>
                <% end %>
              <% end %>

              <!-- Title -->
              <div class="mb-2">
                <h3 class="text-lg font-semibold text-gray-900">
                  <%= link_to ticket.title, alto.board_ticket_path(@board, ticket), class: "hover:text-blue-600" %>
                </h3>
              </div>

              <p class="text-gray-600 text-sm line-clamp-2">
                <%= truncate(ticket.description, length: 150) %>
              </p>
            </div>

            <!-- Upvote Button -->
            <div class="flex flex-col items-center ml-4">
              <%= upvote_button(ticket, current_user) %>
            </div>
          </div>

          <!-- Bottom row: Metadata -->
          <div class="flex items-center space-x-4 text-sm text-gray-500">
            <span>By <span class="font-medium text-gray-700"><%= user_display_name(ticket.user_id) %></span></span>
            <span><%= time_ago_in_words(ticket.created_at) %> ago</span>
            <span><%= link_to pluralize(ticket.comments.count, 'comment'),
                alto.board_ticket_path(@board, ticket, anchor: 'comments'),
                class: "text-gray-500 hover:text-blue-600 font-medium" %></span>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="text-center py-12">
        <% if @search_query.present? %>
          <div class="text-gray-400 text-6xl mb-4">🔍</div>
          <h3 class="text-lg font-medium text-gray-900 mb-2">No <%= board_item_name(@board).pluralize %> found</h3>
          <p class="text-gray-500 mb-4">
            No <%= board_item_name(@board).pluralize %> match your search for "<%= @search_query %>".
            <br>Try different keywords or <%= link_to "browse all #{board_item_name(@board).pluralize}", alto.board_tickets_path(@board, status: params[:status], sort: params[:sort]), class: "text-blue-600 hover:text-blue-500" %>.
          </p>
        <% else %>
          <div class="text-gray-400 text-6xl mb-4">📝</div>
          <h3 class="text-lg font-medium text-gray-900 mb-2">No <%= board_item_name(@board).pluralize %> yet</h3>
          <p class="text-gray-500 mb-4">Be the first to submit feedback!</p>
          <% if can_submit_tickets? %>
            <%= link_to "Create First #{board_item_name(@board).capitalize}", alto.new_board_ticket_path(@board),
                class: "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium" %>
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<style>
.kanban-view .max-h-96::-webkit-scrollbar {
  width: 4px;
}

.kanban-view .max-h-96::-webkit-scrollbar-track {
  background: transparent;
}

.kanban-view .max-h-96::-webkit-scrollbar-thumb {
  background: rgba(156, 163, 175, 0.3);
  border-radius: 2px;
}

.kanban-view .max-h-96::-webkit-scrollbar-thumb:hover {
  background: rgba(156, 163, 175, 0.5);
}

.view-toggle-btn.active {
  background-color: white;
  color: #374151;
  box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
}

.view-toggle-btn:not(.active) {
  color: #6B7280;
}

.view-toggle-btn:not(.active):hover {
  color: #374151;
}
</style>

<script>
// View toggle functionality with cookie persistence
function toggleView(viewType) {
  const cardView = document.getElementById('card-view');
  const rowView = document.getElementById('row-view');
  const statusFilters = document.getElementById('status-filters');
  const cardBtn = document.getElementById('card-view-btn');
  const rowBtn = document.getElementById('row-view-btn');

  if (viewType === 'card') {
    cardView.style.display = 'block';
    rowView.style.display = 'none';
    statusFilters.style.display = 'none';
    cardBtn.classList.add('active');
    rowBtn.classList.remove('active');
  } else {
    cardView.style.display = 'none';
    rowView.style.display = 'block';
    statusFilters.style.display = 'flex';
    cardBtn.classList.remove('active');
    rowBtn.classList.add('active');
  }

  // Save preference in cookie (expires in 1 year)
  const expiry = new Date();
  expiry.setFullYear(expiry.getFullYear() + 1);
  document.cookie = 'tickets-view-type=' + viewType + '; expires=' + expiry.toUTCString() + '; path=/;';
}

// Initialize view based on cookie
document.addEventListener('DOMContentLoaded', function() {
  const cookies = document.cookie.split(';');
  let savedView = 'card'; // default

  for (let cookie of cookies) {
    const [name, value] = cookie.trim().split('=');
    if (name === 'tickets-view-type') {
      savedView = value;
      break;
    }
  }

  toggleView(savedView);
});
</script>
