<div class="space-y-6">
  <% actions = [] %>
  <% if can_submit_tickets? %>
    <% actions << {
      type: :link,
      text: "New #{board_item_name(@board).capitalize}",
      path: alto.new_board_ticket_path(@board),
      button_type: :primary
    } %>
  <% end %>

  <% if can_access_admin? %>
    <% actions << {
      type: :link,
      text: "Modify Board",
      path: alto.edit_admin_board_path(@board.slug),
      button_type: :secondary
    } %>
  <% end %>

  <%= render 'alto/shared/page_header',
      title: @board.name,
      actions: actions %>

      <!-- Filtering Controls -->
  <%= render 'filters_bar' %>

  <!-- Search Results Info -->
  <% if @search_query.present? %>
    <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
      <div class="flex">
        <div class="ml-3">
          <p class="text-sm text-blue-700">
            <span class="font-medium">Search results for:</span> "<%= @search_query %>"
            <% if @tickets.respond_to?(:total_count) %>
              ‚Ä¢ <%= pluralize(@tickets.total_count, board_item_name(@board)) %> found
            <% else %>
              ‚Ä¢ <%= pluralize(@tickets.count, board_item_name(@board)) %> found
            <% end %>
          </p>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Card View (Kanban Style) -->
  <!-- DEBUG: @view_type = <%= @view_type %>, showing card view: <%= @view_type != 'list' %> -->
  <div id="card-view" class="kanban-view min-h-screen" <%= 'style="display: none;"'.html_safe if @view_type == 'list' %>>
    <% if @tickets.any? && @board.has_status_tracking? %>
      <div class="flex overflow-x-auto pb-4 min-h-full">
        <% @statuses.each do |status| %>
          <% status_tickets = @tickets.select { |t| t.status_slug == status.slug } %>
          <div class="flex-shrink-0 w-80 bg-gray-50 rounded-lg p-4 flex flex-col min-h-full">
            <div class="flex items-center justify-between mb-4 flex-shrink-0">
              <div class="flex items-center">
                <span class="w-3 h-3 rounded-full mr-2 <%= case status.color
                  when 'green' then 'bg-green-500'
                  when 'blue' then 'bg-blue-500'
                  when 'yellow' then 'bg-yellow-500'
                  when 'red' then 'bg-red-500'
                  when 'gray' then 'bg-gray-500'
                  when 'purple' then 'bg-purple-500'
                  when 'orange' then 'bg-orange-500'
                  when 'pink' then 'bg-pink-500'
                  else 'bg-gray-500'
                  end %>"></span>
                <h3 class="font-semibold text-gray-900"><%= status.name %></h3>
              </div>
              <span class="text-sm text-gray-500 bg-white px-2 py-1 rounded-full"><%= status_tickets.count %></span>
            </div>

            <div class="space-y-3 flex-1 overflow-y-auto">
              <% status_tickets.each do |ticket| %>
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 hover:shadow-md transition-shadow">
                  <!-- Title and vote arrow row -->
                  <div class="flex items-start justify-between gap-3 mb-3">
                    <div class="flex-1 min-w-0">
                      <h4 class="font-medium text-gray-900 text-sm leading-tight">
                        <%= link_to ticket.title, alto.board_ticket_path(@board, ticket), class: "hover:text-blue-600" %>
                      </h4>
                    </div>
                    <div class="flex-shrink-0">
                      <%= upvote_button(ticket, current_user, size: 'sm') %>
                    </div>
                  </div>

                  <!-- Content preview -->
                  <% if ticket.description.present? %>
                    <div class="mb-3">
                      <p class="text-gray-600 text-xs line-clamp-2">
                        <%= truncate(ticket.description, length: 80) %>
                      </p>
                    </div>
                  <% end %>

                  <!-- Tags -->
                  <% if ticket.tags.any? %>
                    <div class="mb-3">
                      <div class="flex flex-wrap gap-1">
                        <% ticket.tags.limit(3).each do |tag| %>
                          <%= render 'alto/shared/tag', tag: tag, size: 'sm',
                              link: board_tickets_path(@board, tag: tag.name) %>
                        <% end %>
                        <% if ticket.tags.count > 3 %>
                          <span class="text-xs text-gray-500">+<%= ticket.tags.count - 3 %> more</span>
                        <% end %>
                      </div>
                    </div>
                  <% end %>

                  <!-- Separator line -->
                  <div class="border-t border-gray-100 pt-3">
                    <!-- Comments count and timestamp -->
                    <div class="flex items-center justify-between text-xs">
                      <div>
                        <% if ticket.comments.count > 0 %>
                          <%= link_to pluralize(ticket.comments.count, 'comment'),
                              alto.board_ticket_path(@board, ticket, anchor: 'comments'),
                              class: "text-gray-500 hover:text-blue-600 font-medium" %>
                        <% else %>
                          <span class="text-gray-400">No comments</span>
                        <% end %>
                      </div>
                      <div class="text-gray-500">
                        <%= time_ago_in_words(ticket.created_at) %> ago
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- Row View (Traditional List) -->
  <!-- DEBUG: @view_type = <%= @view_type %>, showing list view: <%= @view_type == 'list' %> -->
  <div id="row-view" class="space-y-3" <%= 'style="display: none;"'.html_safe if @view_type == 'card' %>>
    <% if @tickets.any? %>
      <% @tickets.each do |ticket| %>
        <div class="bg-white rounded-lg border border-gray-200 p-4 hover:shadow-sm transition-all">
          <div class="flex items-start gap-4">
            <!-- Upvote Section -->
            <div class="flex flex-col items-center flex-shrink-0 pt-1">
              <%= upvote_button(ticket, current_user, size: :compact) %>
            </div>

            <!-- Main Content -->
            <div class="flex-1 min-w-0">
              <!-- Header with title and status -->
              <div class="flex items-start justify-between mb-2">
                <div class="flex-1 min-w-0">
                  <h3 class="text-lg font-semibold text-gray-900 leading-tight">
                    <%= link_to ticket.title, alto.board_ticket_path(@board, ticket), class: "hover:text-blue-600" %>
                  </h3>
                </div>
                <div class="flex items-center gap-2 flex-shrink-0">
                  <% if @board.has_status_tracking? %>
                    <span class="px-3 py-1 text-sm font-medium rounded-full <%= ticket.status_color_classes %>">
                      <%= ticket.status_name %>
                    </span>
                  <% end %>
                  <% if ticket.locked? %>
                    <span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">
                      üîí Locked
                    </span>
                  <% end %>
                </div>
              </div>

              <!-- Description -->
              <% if ticket.description.present? %>
                <div class="border-b border-gray-100 pb-3 mb-3">
                  <p class="text-gray-600 text-sm line-clamp-2">
                    <%= truncate(ticket.description, length: 120) %>
                  </p>
                </div>
              <% end %>

              <!-- Footer with metadata and tags -->
              <div class="flex items-center justify-between">
                <!-- Left side: User and metadata -->
                <div class="flex items-center space-x-4 text-sm text-gray-500">
                  <div class="flex items-center space-x-2">
                    <%= render 'alto/shared/user_avatar', user_id: ticket.user_id, size: :sm %>
                    <span>By <span class="font-medium text-gray-700"><%= user_display_name(ticket.user_id) %></span></span>
                  </div>
                  <span><%= link_to pluralize(ticket.comments.count, 'comment'),
                      alto.board_ticket_path(@board, ticket, anchor: 'comments'),
                      class: "text-gray-500 hover:text-blue-600 font-medium" %></span>
                  <span><%= time_ago_in_words(ticket.created_at) %> ago</span>
                </div>

                <!-- Right side: Tags -->
                <% if ticket.tags.any? %>
                  <div class="flex flex-wrap gap-2">
                    <% ticket.tags.limit(3).each do |tag| %>
                      <%= render 'alto/shared/tag', tag: tag, size: 'sm',
                          link: board_tickets_path(@board, tag: tag.name) %>
                    <% end %>
                    <% if ticket.tags.count > 3 %>
                      <span class="text-xs text-gray-500">+<%= ticket.tags.count - 3 %> more</span>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="text-center py-12">
        <% if @search_query.present? %>
          <div class="text-gray-400 text-6xl mb-4">üîç</div>
          <h3 class="text-lg font-medium text-gray-900 mb-2">No <%= board_item_name(@board).pluralize %> found</h3>
          <p class="text-gray-500 mb-4">
            No <%= board_item_name(@board).pluralize %> match your search for "<%= @search_query %>".
            <br>Try different keywords or <%= link_to "browse all #{board_item_name(@board).pluralize}", alto.board_tickets_path(@board, status: params[:status], sort: params[:sort]), class: "text-blue-600 hover:text-blue-500" %>.
          </p>
        <% else %>
          <div class="text-gray-400 text-6xl mb-4">üìù</div>
          <h3 class="text-lg font-medium text-gray-900 mb-2">No <%= board_item_name(@board).pluralize %> yet</h3>
          <p class="text-gray-500 mb-4">Be the first to submit feedback!</p>
          <% if can_submit_tickets? %>
            <%= link_to "Create First #{board_item_name(@board).capitalize}", alto.new_board_ticket_path(@board),
                class: "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium" %>
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<style>
.kanban-view .flex-1::-webkit-scrollbar {
  width: 4px;
}

.kanban-view .flex-1::-webkit-scrollbar-track {
  background: transparent;
}

.kanban-view .flex-1::-webkit-scrollbar-thumb {
  background: rgba(156, 163, 175, 0.3);
  border-radius: 2px;
}

.kanban-view .flex-1::-webkit-scrollbar-thumb:hover {
  background: rgba(156, 163, 175, 0.5);
}

.view-toggle-btn.active {
  background-color: white;
  color: #374151;
  box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
}

.view-toggle-btn:not(.active) {
  color: #6B7280;
}

.view-toggle-btn:not(.active):hover {
  color: #374151;
}
</style>
